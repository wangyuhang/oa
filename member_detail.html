<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="css/mui.min.css" rel="stylesheet"/>
    <link href="css/comm.css" rel="stylesheet"/>
    <link href="css/member.css" rel="stylesheet"/>
    <style>
    	body,.mui-content{background-color:#fff;}
    	.mui-content{padding:20px; margin-top:20px;}
    </style>
</head>
<body>
<header class="mui-bar mui-bar-nav">
	<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	<h1 class="mui-title">详情</h1>
</header>

<div class="mui-content">
	<div id="memberDetial">
		<div class="c-base-info">
			<div class="c-avatar"><img src="images/avatar.png"></div>
			<div class="c-name">王大毛</div>
			<div class="c-department">产品技术部（设计师）</div>
		</div>
		<div class="c-short-num c-num-cell">
			<label>短号：</label>
			<span>668899</span>
			<a class="mui-icon mui-icon-phone" href="tel:15888024483"></a>
		</div>
		<div class="c-long-num c-num-cell">
			<label>手机号：</label>
			<span>15888024475</span>
			<a class="mui-icon mui-icon-phone" href="tel:15888024483"></a>
			<a class="mui-icon mui-icon-chatbubble" href="sms:10086"></a>
		</div>
		<div class="c-office-num c-num-cell">
			<label>办公室：</label>
			<span>65714746</span>
			<a class="mui-icon mui-icon-phone" href="tel:15888024483"></a>
		</div>
		<div id="tagList" class="c-tag">
			
		</div>
	</div>
</div>
<div style="height:61px;"></div>
<footer  class="c-footer-botton">
	<button id="addTag" type="button" class="mui-btn mui-btn-success mui-btn-block">贴标签</button>
</footer>
</body>
</html>
<script src="js/zepto.min.js"></script>
 <script src="js/mui.min.js"></script>
 <script type="text/javascript" charset="utf-8">
  	mui.init();
  	
  	//获取详细信息
  	function getMember(mid) {
		mui.ajax('http://192.168.200.215/directory/frontend/web/index.php?r=site/get-information', {
			data: {
				id: mid
			},
			dataType:'json',
			type:'get',
			timeout:10000,
			success:function(result){
				if(result.succ) {
					var html = '',
						tagHtml = '';
					mui.each(result.data.tag, function() {
						tagHtml += '<button type="button" class="mui-btn mui-btn-success" info="from：'+this.from+'">'+this.tag+
						'<span class="mui-badge mui-badge-danger deletButtom" info="'+this.tag+' from：'+this.from+'" tid="'+this.tid+'">x</span></button>'
					});
					html = '<div class="c-base-info">'+
									'<div class="c-avatar"><img src="'+result.data.avatar+'"></div>'+
									'<div class="c-name">'+result.data.name+'</div>'+
									'<div class="c-department">'+result.data.department+'</div>'+
								'</div>'+
								'<div class="c-short-num c-num-cell">'+
									'<label>短号：</label>'+
									'<span>'+result.data.short+'</span>'+
									'<a class="mui-icon mui-icon-phone" href="tel:'+result.data.short+'"></a>'+
								'</div>'+
								'<div class="c-long-num c-num-cell">'+
									'<label>手机号：</label>'+
									'<span>'+result.data.cellphone+'</span>'+
									'<a class="mui-icon mui-icon-phone" href="tel:'+result.data.cellphone+'"></a>'+
									'<a class="mui-icon mui-icon-chatbubble" href="sms:'+result.data.cellphone+'"></a>'+
								'</div>'+
								'<div class="c-office-num c-num-cell">'+
									'<label>办公室：</label>'+
									'<span>'+result.data.office+'</span>'+
									'<a class="mui-icon mui-icon-phone" href="tel:'+result.data.office+'"></a>'+
								'</div>'+
								'<div class="c-office-num c-num-cell">'+
									'<label>邮箱：</label>'+
									'<span>'+result.data.email+'</span>'+
									'<a class="mui-icon mui-icon-phone" href="mailto:'+result.data.email+'"></a>'+
								'</div>'+
								'<div id="tagList" class="c-tag">'+tagHtml+'</div>'
					$('#memberDetial').html(html);	
					$('#addTag').attr({'tagToName': result.data.name, 'tagToId': mid});
				}else {
					mui.toast('获取数据失败');
				}
				waiting.close();
			},
			error:function(xhr,type,errorThrown){
				mui.toast('请检查网络');	     
				waiting.close() ;
			}
		});
	}
  	
  	//添加标签from{name,id}, to{name, id}, content
  	function addTag(from, to, content) {
  		mui.ajax('http://192.168.200.215/directory/frontend/web/index.php?r=site/add-tag', {
			data: {
				from: from.id,
				to: to.id,
				content: content
			},
			type: 'get',
			dataType: 'json',
			timeout: 10000,
			success: function(result) {
				if (result.succ) {
					$('#tagList').prepend('<button type="button" class="mui-btn mui-btn-success" info="from: '+from.name+'">'+content+
					'<span class="mui-badge mui-badge-danger deletButtom" info="'+content+' from：'+from.name+'" tid="'+result.data.tid+'">x</span></button>')
				} else{
					mui.toast('添加失败');
				}
			},
			error: function(xhr,type,errorThrown) {
					mui.toast('请检查网络');
			}
		})
  	}
  	
  	//添加标签from{name,id}, to{name, id}, content
  	function deletTag(tid, mid, tag) {
  		mui.ajax('http://192.168.200.215/directory/frontend/web/index.php?r=site/del-tag', {
			data: {
				tid: tid,
				id: mid
			},
			type: 'get',
			dataType: 'json',
			timeout: 10000,
			success: function(result) {
				if (result.succ) {
					tag.remove();
				} else{
					mui.toast('删除失败');
				}
			},
			error: function(xhr,type,errorThrown) {
					mui.toast('请检查网络');
			}
		})
  	}
  	
  	mui('#memberDetial').on('tap', 'button', function() {
  		var info = this.getAttribute('info')
  		mui.toast(info);
  	})
  	
  	//添加标签
  	mui('footer').on('tap', '#addTag', function(event) {
  		event.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
  		var fromName = localStorage.getItem('name'),
  			fromId = localStorage.getItem('id'),
  			toId = $(this).attr('tagToId'),
  			toName = $(this).attr('tagToName');
		var btnArray = ['确定', '取消'];
		mui.prompt('from '+fromName+' to '+toName, '', '', btnArray, function(e) {
			if (e.index == 0) {
				var from = {'id': fromId, 'name': fromName},
					to = {'id': toId, 'name': toName},
					content = e.value;
				if($.trim(content) != '') {
					addTag(from, to, content);
				}
			} else {
				
			}
		})
  	})
  	
  	//删除标签
  	mui('#memberDetial').on('tap', '.deletButtom', function(e) {
  		var btnArray = ['是', '否'];
  		var info = $(this).attr('info'),
  			thisTag = $(this).parent(),
  			tid = $(this).attr('tid');
		mui.confirm('是否删除'+info, '', btnArray, function(e) {
			if (e.index == 0) {
				deletTag(tid, mid, thisTag);
			} else {
			}
		})
		e.stopPropagation();
  		return false;
  	})
  	
  	
  	var waiting = null;
  	var mid = '';
  	mui.plusReady(function(){
  		mid = plus.webview.currentWebview().mid;
  		waiting = plus.nativeUI.showWaiting('请等待...');
  		getMember(mid);
  	})
</script>